#!/usr/bin/env node

const config = require('config')

const { RtmClient, WebClient } = require('@slack/client')

const Atlassian = require('../lib/atlassian')
const Confluence = require('../lib/confluence')
const ConfluenceSpaces = require('../lib/confluence_spaces')
const ConfluenceResolver = require('../lib/confluence_resolver')
const Jira = require('../lib/jira')
const JiraResolver = require('../lib/jira_resolver')
const JiraProjects = require('../lib/jira_projects')
const SlackBot = require('../lib/slack_bot')
const SlackRoomList = require('../lib/slack_room_list')

const ATLASSIAN = config.get('atlassian')
const { teams, username, iconUrl, refresh } = config.get('slack')
const JIRA_PROJECTS = config.get('jiraProjects')
const CONFLUENCE_SPACES = config.get('confluenceSpaces')

!function() {
  const atlassian = new Atlassian(ATLASSIAN)
  const confluence = new Confluence({ atlassian })
  const confluenceSpaces = new ConfluenceSpaces(CONFLUENCE_SPACES)
  const confluenceResolver = new ConfluenceResolver({ confluence, confluenceSpaces })

  // !async function() {
  //   console.log(await confluence.resolveContent('94022844'))
  // }()
  // const jira = new Jira({ atlassian })
  // const jiraProjects = new JiraProjects(JIRA_PROJECTS)
  // const jiraResolver = new JiraResolver({ jira, jiraProjects })

  // teams.forEach(async team => {
  //   const rtm = new RtmClient(team.token, { autoReconnect: true, logLevel: 'error' })
  //   const web = new WebClient(team.token)

  //   const rooms = new SlackRoomList({ domain: team.name, web, refresh })
  //   await rooms.sync()

  //   const slackBot = new SlackBot({ rtm, web, team: team.name, jiraResolver, rooms, username, iconUrl })
  //   slackBot.listen()
  // })
}()

// vim: se sw=2 ts=2 sts=2 et ft=javascript :
